---
  #Setup Play1: Configure spine switches
  - name: configure spine01
    hosts: spine01
    become: yes
    vars_files:
      - vars.yml
    tasks:
    #Task 1: Configure BGP Unnumbered and announce loopbacks 
    - name: configure spine01 for BGP Unnumbered
      nclu:
        commands:
        - add loopback lo ip address {{ devices[ansible_hostname].loopback }}
        - add bgp autonomous-system {{ devices[ansible_hostname].as }}
        commit: false
    
    #Task 2: Configure BGP neighbors and enable BGP unnumbered on the interfaces to the leafs
    - name: Configure bgp neighbors
      nclu:
        commands:
        - add bgp neighbor {{ item }} interface remote-as external
        - add bgp neighbor {{ item }} capability extended-nexthop
        commit: false
      #with_items creates a list from the variables mentiond in the vars.yml file and will parse the list with the commands above. If there a 4 values in the list the commands will run 4 times
      with_items: "{{ devices[ansible_hostname].leaf_ports }}"

    #Task 3: Announce loopbacks in BGP
    - name: Announce loopbacks in BGP
      nclu: 
        commands:
        - add routing route-map allow-loopback permit 10 match interface lo
        - add routing route-map allow-loopback permit 10 set origin igp
        - add routing route-map allow-loopback deny 20
        - add bgp redistribute connected route-map allow-loopback
        commit: false

    #Task4: Enable EVPN VXLAN
    - name: Configure EVPN VXLAN
      nclu:
        commands:
        - add bgp l2vpn evpn neighbor {{ item }} activate
        commit: true
      with_items: "{{ devices[ansible_hostname].leaf_ports }}"
  
  